name: Mocked backend tests

on:
  # push:
    # branches: [master, develop]
  pull_request:
    # branches: [master, develop]
    types: [labelled]

jobs:
  cypress-run:
    name: Cypress run
    runs-on: ubuntu-latest
    # https://github.com/cypress-io/cypress-docker-images/blob/master/browsers/README.md for more browser
    container: cypress/browsers:node14.17.0-chrome91-ff89
    if: ${{ github.event.label.name == 'readyTest' }}
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install root dependencies
        run: yarn install
      - name: Start server in the background
        run: REACT_APP_REDEEM_LIVE=0 REACT_APP_CHAIN=0x3 REACT_APP_SHOW_NETWORK_SWITCHER=1 yarn start:mock &
        env:
          REACT_APP_REDEEM_LIVE: 0
          REACT_APP_CHAIN: 0x3
          REACT_APP_SHOW_NETWORK_SWITCHER: 1
      # Install yarn automation/ dependencies, cache them correctly
      # and run all Cypress tests
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          parallel: true
          wait-on: "http://localhost:3000"
          working-directory: automation
          wait-on-timeout: 120
          record: true
        env:
          # pass the Dashboard record key as an environment variable
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          # Recommended: pass the GitHub token lets this action correctly
          # determine the unique run id necessary to re-run the checks
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # pass the project ID from the secrets through environment variable
          CYPRESS_PROJECT_ID: ${{ secrets.PROJECT_ID }}
