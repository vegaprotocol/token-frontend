name: WDIO tests + browserstack
on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  prepare:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: automation
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 14.17.1
      - name: Install root dependencies
        run: npm run yarn:install:deps
      - name: Install
        run: npm install
      # - name: Download wallet
      #   run: curl -L https://github.com/vegaprotocol/vegawallet/releases/download/v0.13.1/vegawallet-linux-amd64.zip -O
      #   # run: curl -L https://github.com/vegaprotocol/vegawallet/releases/download/v${{ matrix.vegawallet-version }}/vegawallet-linux-amd64.zip -O
      # - name: ls current
      #   run: ls
      # - name: ls previous
      #   run: ls ..
      # - name: Unzip wallet
      #   run: unzip vegawallet-linux-amd64.zip
      - name: Download and Unzip latest wallet
        run: curl -s https://api.github.com/repos/vegaprotocol/vegawallet/releases/latest | awk -F\" '/browser_download_url.*linux-amd64.zip/{print $(NF-1)}' | xargs wget && unzip vegawallet-linux-amd64.zip && rm vegawallet-linux-amd64.zip
      - name: Initialize wallet
        run: ./vegawallet init -f
      - name: Create recovery phrase file
        run: echo ${{ secrets.TEST_WALLET_RECOVERY }} > recovery-phrase.txt
      - name: Create recovery phrase file
        run: echo "dev12345" > passphrase.txt
      - name: Import wallet
        run: ./vegawallet import --wallet UI_TEST_1 --recovery-phrase-file recovery-phrase.txt --passphrase-file passphrase.txt
      - name: Import config
        run: ./vegawallet network import --from-url https://raw.githubusercontent.com/vegaprotocol/networks/master/fairground/fairground.toml
      - name: List networks
        run: ./vegawallet network list
      - name: Start service
        run: ./vegawallet service run --network fairground  &
      - name: "BrowserStack Env Setup" # Invokes the setup-env action
        uses: browserstack/github-actions/setup-env@master
        with:
          username: ${{ secrets.BROWSERSTACK_USER }}
          access-key: ${{ secrets.BROWSERSTACK_KEY }}
        env:
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}

      - name: "BrowserStack Local Tunnel Setup" # Invokes the setup-local action
        uses: browserstack/github-actions/setup-local@master
        with:
          local-testing: start
      - name: Start localhost
        run: npm run yarn:start &
      - name: Run tests
        run: npm run wdio
        env:
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}
      - name: Get Allure history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      # Generate report
      - name: Allure Report action from marketplace
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: automation/allure-results
          allure_history: automation/allure-history
          keep_reports: 30
      - name: Deploy report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v2
        env:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: automation/allure-history
      - name: Allure report location
        if: always()
        run: echo "Link to report https://vegaprotocol.github.io/token-frontend/${{ github.run_number }}"
